# 多角度相机 - 完整功能说明

## 功能概述

多角度相机节点可以基于输入图片，生成 **21:9 超宽比例的九宫格图片**（3行3列，共9个格子），所有格子保持主体和背景完全一致，仅在光照、色调、艺术风格上有细微变化。

## 核心要求

### 1. 九宫格布局 ✅
- 3行 × 3列 = 9个格子
- 21:9 超宽比例
- 格子之间有细微分隔线

### 2. 完美一致性 ✅
- **人物一致性**：外观、服装、特征、姿势完全相同
- **背景一致性**：场景、环境、道具完全相同
- **角度一致性**：所有格子使用相同的拍摄角度

### 3. 角度控制 ✅
- **水平角度**（Horizontal Angle）：0-360度
  - 0° = 正面
  - 45° = 右前方45度
  - 90° = 右侧面
  - 135° = 右后方
  - 180° = 背面
  - 225° = 左后方
  - 270° = 左侧面
  - 315° = 左前方45度

- **垂直角度**（Vertical Angle）：-90 到 90度
  - -90° 到 -20° = 仰拍
  - -20° 到 10° = 平视
  - 10° 到 40° = 俯拍
  - 40° 到 90° = 高角度俯拍

- **相机距离**（Camera Zoom）：0-10
  - 0-2 = 特写
  - 2-4 = 近景
  - 4-6 = 中景
  - 6-10 = 远景

### 4. 细微变化 ✅
九个格子的区别仅在于：
- 光照效果
- 色调调整
- 艺术风格的细微变化

## 图片压缩功能

### 问题
西瓜皮 API 可能不支持太大的图片（如 3MB 以上）

### 解决方案
自动压缩功能：
- **上传时**：自动压缩到最大宽度 1024px
- **下载时**：保持原图质量（API 返回的是原始生成结果）

### 压缩逻辑
```typescript
compressImageIfNeeded(base64, maxWidth = 1024)
```

1. 检查图片宽度
2. 如果 ≤ 1024px，直接使用原图
3. 如果 > 1024px，按比例缩小到 1024px
4. 使用 JPEG 格式，质量 0.85
5. 输出压缩后的 base64

### 压缩效果
- 原图：3MB → 压缩后：~500KB
- 保持视觉质量
- 加快 API 处理速度

## 使用流程

### 步骤 1: 准备输入图片
1. 创建"文字生图"节点
2. 生成或上传一张图片
3. 确保图片清晰，主体明确

### 步骤 2: 创建多角度相机节点
1. 从侧边栏拖入"多角度相机"节点
2. 连接输入图片到多角度相机

### 步骤 3: 设置参数
1. **水平角度**：调整左右方向（0-360°）
2. **垂直角度**：调整上下方向（-90 到 90°）
3. **相机距离**：调整远近（0-10）
4. **额外提示**（可选）：添加风格要求

### 步骤 4: 生成九宫格
1. 点击"生成"按钮
2. 等待 API 处理（可能需要 30-60 秒）
3. 查看生成的 21:9 九宫格图片

### 步骤 5: 使用结果
- 九宫格图片会自动传递给下游节点
- 可以连接"九宫格处理"节点进行切割
- 可以直接下载使用

## API 调用流程

```
用户设置参数
    ↓
构建九宫格提示词
    ↓
压缩输入图片（如果 > 1024px）
    ↓
调用西瓜皮 API（图生图模式）
    ↓
等待任务完成
    ↓
返回 21:9 九宫格图片
    ↓
显示在节点中
```

## 提示词模板

```
基于参考图片，生成一张 21:9 超宽比例的九宫格图片（3行3列，共9个格子）。

要求：
1. 所有9个格子中的主体（人物/物体）必须完全一致，包括外观、服装、特征、姿势、背景
2. 所有格子的拍摄角度都是：[角度描述]
3. 9个格子的区别仅在于光照、色调、艺术风格的细微变化
4. 保持相同的画风和质量
5. 格子之间有细微的分隔线
6. 整体图片比例为 21:9（超宽屏）
7. 完美保持画面中的人物和背景一致性
8. 额外风格要求：[用户输入]
```

## 常见问题

### Q1: 为什么生成失败？
**可能原因**：
1. 输入图片太大（> 3MB）
2. 输入图片格式不支持
3. 提示词太复杂
4. API 配额不足

**解决方案**：
- 自动压缩功能已启用
- 检查控制台日志查看详细错误
- 简化额外提示词
- 检查 API 余额

### Q2: 九宫格中的主体不一致？
**可能原因**：
1. 输入图片主体不明确
2. 背景太复杂
3. API 理解有偏差

**解决方案**：
- 使用主体清晰的输入图片
- 在额外提示中强调"保持主体完全一致"
- 多次生成选择最佳结果

### Q3: 角度控制不准确？
**说明**：
- 角度描述是给 AI 的参考
- AI 会尽量理解并执行
- 可能需要多次调整参数

**建议**：
- 使用标准角度（0°, 45°, 90° 等）
- 在额外提示中详细描述期望的角度
- 结合多个参数调整

### Q4: 压缩后图片质量下降？
**说明**：
- 压缩只影响**上传到 API 的图片**
- **生成的结果**是 API 原始输出，无损
- 压缩使用 JPEG 质量 0.85，视觉损失很小

**如果需要更高质量**：
- 修改 `maxWidth` 参数（默认 1024）
- 修改 JPEG 质量（默认 0.85）

## 技术细节

### 图片压缩实现
```typescript
const compressImageIfNeeded = async (base64: string, maxWidth: number = 1024): Promise<string> => {
  // 1. 加载图片
  // 2. 检查尺寸
  // 3. 如果太大，使用 Canvas 缩放
  // 4. 转换为 JPEG，质量 0.85
  // 5. 返回压缩后的 base64
};
```

### 角度描述生成
```typescript
// 水平角度 → 方位描述
0° → "正面"
45° → "右前方45度"
90° → "右侧面"
...

// 垂直角度 → 仰俯描述
-30° → "仰拍"
0° → "平视"
30° → "俯拍"

// 距离 → 景别描述
2 → "特写"
4 → "近景"
6 → "中景"
8 → "远景"
```

### API 参数
```typescript
{
  prompt: "九宫格提示词",
  model: "nanobananapro",
  aspectRatio: "21:9",
  count: 1,
  referenceUrls: [compressedImage]  // 压缩后的图片
}
```

## 性能优化

### 已实现
- ✅ 自动图片压缩
- ✅ 智能尺寸检测
- ✅ 压缩日志输出

### 未来优化
- 🔄 批量生成多个角度
- 🔄 缓存压缩结果
- 🔄 并行处理多个任务

---

**多角度相机功能已完整实现！** 🎉

支持：
- ✅ 21:9 超宽比例
- ✅ 九宫格布局
- ✅ 完美角度控制
- ✅ 人物和背景一致性
- ✅ 自动图片压缩
