# 连接线优化完成

## 修复内容

### 1. 修复新增节点类型的高度计算
**问题**：App.tsx 中的 `getApproxNodeHeight` 函数没有处理新增的故事创作节点类型（STORY_STUDIO、CHARACTER_REFERENCE、SCENE_REFERENCE、STORYBOARD_SHOT），导致这些节点使用了默认的 16:9 比例计算高度，连接线锚点位置不准确。

**解决方案**：
在 `getApproxNodeHeight` 函数中添加了新节点类型的高度计算：

```typescript
const getApproxNodeHeight = (node: AppNode) => {
    if (node.height) return node.height;
    const width = node.width || 420;
    if (['PROMPT_INPUT', 'VIDEO_ANALYZER', 'IMAGE_EDITOR'].includes(node.type)) return 360;
    if (node.type === NodeType.AUDIO_GENERATOR) return 200;
    
    // 新增：故事创作节点的高度
    if (node.type === NodeType.STORY_STUDIO) {
        // 创意工作室：选中时展开，未选中时收起
        const isSelected = selectedNodeIds.includes(node.id);
        return isSelected ? 500 : 120;
    }
    if (node.type === NodeType.CHARACTER_REFERENCE || node.type === NodeType.SCENE_REFERENCE) {
        return 400;
    }
    if (node.type === NodeType.STORYBOARD_SHOT) {
        return 450;
    }
    
    const [w, h] = (node.data.aspectRatio || '16:9').split(':').map(Number);
    const extra = (node.type === NodeType.VIDEO_GENERATOR && node.data.generationMode === 'CUT') ? 36 : 0;
    return ((width * h / w) + extra);
};
```

**节点高度对应关系**：
- **创意工作室** (STORY_STUDIO)：选中时 500px，未选中时 120px（动态高度）
- **角色参考** (CHARACTER_REFERENCE)：400px
- **场景参考** (SCENE_REFERENCE)：400px
- **分镜生成** (STORYBOARD_SHOT)：450px

### 2. 移除 RAF 节流，实现实时更新
**问题**：之前使用 `requestAnimationFrame` 节流导致节点拖拽时连接线更新有延迟，显得很呆。

**解决方案**：
- 移除了 `rafRef` 的 RAF 节流机制
- 改为直接在 `handleGlobalMouseMove` 中立即更新鼠标位置和节点位置
- 连接线现在会实时跟随节点移动，没有任何延迟

```typescript
// 之前：使用 RAF 节流
if (rafRef.current) return;
rafRef.current = requestAnimationFrame(() => {
    // ... 更新逻辑
});

// 现在：立即更新
const handleGlobalMouseMove = useCallback((e: MouseEvent) => {
    const { clientX, clientY } = e;
    
    // 立即更新鼠标位置（用于连接线绘制）
    setMousePos({ x: clientX, y: clientY });
    
    // 立即更新节点位置
    setNodes(prev => prev.map(n => n.id === draggingNodeId ? { ...n, x: proposedX, y: proposedY } : n));
}, [/* 依赖项 */]);
```

### 3. 端口锚点位置精确计算
**问题**：连接线没有精确连接到端口的十字点中心。

**当前计算逻辑**（已验证正确）：
- **输入端口**：`-left-3` = `left: -0.75rem` = `-12px`，端口宽高 `w-4 h-4` = `16px`
  - 端口中心位置：节点左边缘 - 4px
  
- **输出端口**：`-right-3` = `right: -0.75rem` = `-12px`，端口宽高 `w-4 h-4` = `16px`
  - 端口中心位置：节点右边缘 + 4px

```typescript
// 输出端口中心
const fx = f.x + fWidth + 4;
const fy = f.y + fHeight/2;

// 输入端口中心
const tx = t.x - 4;
const ty = t.y + tHeight/2;
```

### 4. 贝塞尔曲线优化
使用自适应控制点让连接线更流畅：

```typescript
// 计算水平距离，用于调整控制点
const dx = tx - fx;
const controlOffset = Math.min(Math.abs(dx) * 0.6, 200);

// 贝塞尔曲线：使用更自然的控制点
const d = `M ${fx} ${fy} C ${fx + controlOffset} ${fy}, ${tx - controlOffset} ${ty}, ${tx} ${ty}`;
```

### 5. 连接线样式
- **颜色**：单色白色 `rgba(255,255,255,0.25)`
- **线型**：实线（不是虚线）
- **粗细**：2.5px
- **端点**：圆角 `strokeLinecap="round"`
- **交互**：hover 时变亮并加粗到 3px

## 动态高度处理

**创意工作室节点的特殊处理**：
- 该节点的高度依赖于选中状态（`selectedNodeIds`）
- 选中时展开到 500px，未选中时收起到 120px
- 当节点选中状态变化时，React 会自动重新渲染连接线
- 连接线会根据新的节点高度重新计算锚点位置（`fy = f.y + fHeight/2`）

这确保了即使节点高度动态变化，连接线也始终精确连接到端口中心。

## 性能优化

1. **移除 RAF 节流**：虽然 RAF 通常用于性能优化，但在这个场景下它导致了视觉延迟。直接更新 state 反而更流畅，因为 React 的批处理机制已经足够高效。

2. **保持 memo 优化**：Node 组件仍然使用 `React.memo` 和自定义比较函数，避免不必要的重渲染。

## 测试建议

1. **拖拽测试**：
   - 拖动节点，观察连接线是否实时跟随
   - 连接线应该没有任何延迟或"橡皮筋"效果

2. **锚点测试**：
   - 创建两个节点并连接（包括新的故事创作节点）
   - 放大画布（缩放）检查连接线是否精确连接到端口中心的十字点
   - 移动节点，连接线应该始终保持精确连接

3. **动态高度测试**：
   - 创建创意工作室节点并连接到其他节点
   - 点击选中/取消选中该节点
   - 观察连接线是否随着节点高度变化而正确调整锚点位置

4. **性能测试**：
   - 创建多个节点（10+）并建立多条连接
   - 拖动节点，观察是否流畅
   - 如果出现卡顿，可能需要考虑其他优化策略

## 可能的进一步优化

如果在大量节点时仍有性能问题，可以考虑：

1. **使用 CSS Transform**：将节点位置改为 CSS transform 而不是 left/top
2. **虚拟化**：只渲染视口内的节点和连接线
3. **Web Worker**：将复杂计算移到 Worker 线程
4. **Canvas 渲染**：对于大量连接线，使用 Canvas 代替 SVG

但目前的实现应该足够流畅，适合中小型工作流（<50个节点）。

