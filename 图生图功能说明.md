# 图生图功能说明

## 当前实现

### 方案：混合 API 策略

1. **纯文本生图** → 西瓜皮 API（Nano Banana Pro）
   - 优点：速度快，质量好
   - 使用场景：用户只输入文字描述

2. **图生图** → Gemini API（gemini-2.5-flash-image）
   - 原因：西瓜皮 API 需要图片 URL，但前端传入的是 base64
   - 使用场景：用户上传图片 + 文字描述

## 为什么不全部使用西瓜皮？

### 问题：base64 vs URL

**西瓜皮 API 要求**:
```json
{
  "prompt": "...",
  "model": "nanobananapro",
  "image_urls": ["https://example.com/image.png"]  // 需要 URL
}
```

**前端实际数据**:
```javascript
inputImages = ["data:image/png;base64,iVBORw0KGgoAAAANS..."]  // base64
```

### 解决方案对比

#### 方案 1: 使用 Gemini API（当前实现）✅
- **优点**：
  - 无需额外服务
  - Gemini 支持 base64 输入
  - 实现简单
- **缺点**：
  - 图生图和文生图使用不同的 API
  - Gemini 可能有配额限制

#### 方案 2: 上传图片到图床
- **优点**：
  - 可以全部使用西瓜皮 API
  - 统一的生成质量
- **缺点**：
  - 需要额外的图片托管服务
  - 增加延迟（上传时间）
  - 可能有隐私问题

#### 方案 3: 使用临时 Blob URL
- **优点**：
  - 不需要外部服务
- **缺点**：
  - Blob URL 只在本地有效
  - 西瓜皮 API 无法访问

## 如何切换到完全使用西瓜皮？

如果你想让图生图也使用西瓜皮 API，需要：

### 步骤 1: 选择图片托管服务

推荐的免费服务：
- **imgbb.com** - 免费，有 API
- **imgur.com** - 免费，有 API
- **cloudinary.com** - 免费额度

### 步骤 2: 实现上传函数

```typescript
const uploadBase64ToImgbb = async (base64: string): Promise<string> => {
  const apiKey = 'YOUR_IMGBB_API_KEY';
  const formData = new FormData();
  formData.append('image', base64.replace(/^data:image\/\w+;base64,/, ''));
  
  const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
    method: 'POST',
    body: formData
  });
  
  const result = await response.json();
  return result.data.url;
};
```

### 步骤 3: 修改 generateImageFromText

```typescript
if (inputImages.length > 0) {
  // 上传图片获取 URL
  const imageUrls = await Promise.all(
    inputImages.map(img => uploadBase64ToImgbb(img))
  );
  
  // 使用西瓜皮 API
  const xiguapiOptions = {
    model: 'nanobananapro',
    aspectRatio: options.aspectRatio || '16:9',
    resolution: options.resolution || '1K',
    referenceUrls: imageUrls,  // 传入 URL
    num: count
  };
  
  return await generateXiguapiImage(prompt, xiguapiOptions);
}
```

## 当前使用方法

### 文生图（使用西瓜皮）
1. 创建"文字生图"节点
2. 输入提示词："一只可爱的小猫"
3. 点击生成
4. ✅ 使用 Nano Banana Pro 生成

### 图生图（使用 Gemini）
1. 创建"文字生图"节点
2. 上传一张图片
3. 输入提示词："把这只猫变成卡通风格"
4. 点击生成
5. ✅ 使用 Gemini 生成

## 测试建议

### 测试 1: 纯文本生图
- 输入："一只在太空飞行的猫"
- 预期：使用西瓜皮 API，生成高质量图片

### 测试 2: 图生图
- 上传一张猫的图片
- 输入："变成赛博朋克风格"
- 预期：使用 Gemini API，基于输入图片生成新图片

## 优化建议

### 短期（当前方案）
- ✅ 保持混合 API 策略
- ✅ 在 UI 中提示用户使用的 API
- ✅ 添加错误处理和重试机制

### 长期（统一方案）
- 🔄 实现图片上传服务
- 🔄 全部使用西瓜皮 API
- 🔄 添加图片缓存机制

---

**当前实现已完成，图生图功能可用！** 🎉
