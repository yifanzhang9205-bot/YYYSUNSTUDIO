# 调试：查询任务 400 错误

## 问题现象

从用户截图看到：
1. ✅ 任务创建成功（API 后端可以看到生成的图片）
2. ❌ 所有查询请求都返回 400 (Bad Request)
3. ❌ 每次轮询都显示 `undefined`
4. ❌ 最终显示"生成图片失败: Error: 任务超时: 等待时间过长"

## 已完成的修复

### 1. 修复了创建任务的响应格式检查
- ✅ 从 `result.success` 改为 `result.code`
- ✅ 任务创建现在可以正常工作

### 2. 添加了详细的调试日志
现在会输出：
- 查询请求的完整内容
- 响应状态码和状态文本
- 响应的完整 JSON 内容

### 3. 修复了语法错误
- ✅ 删除了重复的 `}` 符号

## 下一步调试

请重新运行图片生成，然后查看控制台日志，应该会看到：

```
[Xiguapi] 创建任务: {...}
[Xiguapi] API 响应: {...}
[Xiguapi] 任务创建成功，taskid: xxx
[Xiguapi] 开始轮询任务: xxx
[Xiguapi] 查询任务请求: {"taskId": "xxx"}
[Xiguapi] 查询响应状态: 400 Bad Request
[Xiguapi] 查询响应内容: {...}
```

## 可能的原因

### 原因 1: API 字段名不一致
- 创建任务返回：`taskid`（小写）
- 查询任务需要：`taskId`（驼峰）？

**测试方法**：查看日志中的 `taskid` 值，确认格式是否正确

### 原因 2: API 端点不同
可能创建和查询使用不同的端点？

**当前代码**：
- 创建：`POST https://tasks.xiguapi.tech/`
- 查询：`POST https://tasks.xiguapi.tech/`（相同）

### 原因 3: 请求头或认证问题
可能查询请求需要不同的认证方式？

**当前代码**：
```typescript
headers: {
  'Content-Type': 'application/json',
  'Authorization': `Bearer ${API_KEY}`
}
```

### 原因 4: 请求体格式问题
可能 API 期望的格式不是 `{"taskId": "xxx"}`？

## 临时解决方案

如果查询一直失败，可以考虑：

### 方案 1: 直接返回 URL 而不是 base64
修改代码，不进行 URL 到 base64 的转换，直接使用图片 URL

### 方案 2: 使用轮询间隔更长
给 API 更多时间处理任务

### 方案 3: 检查 API 文档
联系 API 提供商确认正确的查询格式

## 需要用户提供的信息

请运行一次图片生成，然后提供：

1. **完整的控制台日志**，特别是：
   - `[Xiguapi] 任务创建成功，taskid: xxx` 这一行的完整 taskid
   - `[Xiguapi] 查询任务请求:` 这一行的完整请求体
   - `[Xiguapi] 查询响应内容:` 这一行的完整响应

2. **API 后端的截图**
   - 显示任务 ID
   - 显示任务状态

3. **API 文档链接**（如果有）
   - 确认查询任务的正确格式

## 代码修改位置

文件：`services/xiguapiService.ts`

已添加的调试日志：
```typescript
// 查询请求
console.log('[Xiguapi] 查询任务请求:', JSON.stringify(requestBody, null, 2));

// 响应状态
console.log('[Xiguapi] 查询响应状态:', response.status, response.statusText);

// 响应内容
console.log('[Xiguapi] 查询响应内容:', JSON.stringify(result, null, 2));
```

---

**等待用户提供详细日志以继续调试** 🔍
