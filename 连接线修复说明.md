# 连接线修复说明

## ✅ 已修复的问题

### 1. 连接线位置不正确
**问题**：连接线的起点和终点位置计算不准确

**修复**：
- 输出端口：节点右侧 (`x + width + 3`)
- 输入端口：节点左侧 (`x - 3`)
- 根据 `portType` 动态计算起点位置

### 2. 拖拽连接线时的起点位置
**问题**：拖拽时连接线起点固定在输出端口

**修复**：
- 从输出端口拖拽：起点在右侧
- 从输入端口拖拽：起点在左侧
- 根据 `connectionStart.portType` 判断

### 3. 连接方向错误
**问题**：从输入端口拖拽时，连接方向不正确

**修复**：
- 输出 → 输入：正常连接 (from → to)
- 输入 → 输出：反转连接 (to → from)
- 输出 → 输出：不允许
- 输入 → 输入：不允许

### 4. 智能连接菜单不完整
**问题**：新节点类型没有加入智能连接逻辑

**修复**：
- 创意工作室 → 角色参考/场景参考/分镜生成
- 角色参考 → 分镜生成
- 场景参考 → 分镜生成
- 分镜生成 → 序列编排（待实现）

## 🎯 测试方法

### 测试连接线位置
1. 创建两个节点
2. 从第一个节点的输出端口（右侧圆点）拖拽
3. 连接到第二个节点的输入端口（左侧圆点）
4. 检查连接线是否正确连接到端口

### 测试双向拖拽
1. 从输出端口拖拽到输入端口 ✓
2. 从输入端口拖拽到输出端口 ✓
3. 从输出端口拖拽到输出端口 ✗（不允许）
4. 从输入端口拖拽到输入端口 ✗（不允许）

### 测试智能连接
1. 创建"创意工作室"节点
2. 从输出端口拖拽，松手不连接任何节点
3. 应该弹出菜单，显示：角色参考、场景参考、分镜生成
4. 点击任意选项，自动创建节点并连接

### 测试故事创作流程
1. 创意工作室 → 拖拽输出 → 松手 → 选择"角色参考"
2. 创意工作室 → 拖拽输出 → 松手 → 选择"场景参考"
3. 角色参考 → 拖拽输出 → 松手 → 选择"分镜生成"
4. 场景参考 → 拖拽输出 → 松手 → 选择"分镜生成"

## 📝 技术细节

### 连接线计算
```typescript
// 输出端口（右侧）
const fx = f.x + fWidth + 3;
const fy = f.y + fHeight / 2;

// 输入端口（左侧）
const tx = t.x - 3;
const ty = t.y + tHeight / 2;
```

### 拖拽时的起点
```typescript
if (connectionStart.portType === 'input') {
    startX = startNode.x - 3;  // 左侧
} else {
    startX = startNode.x + startWidth + 3;  // 右侧
}
```

### 连接方向判断
```typescript
if (start.portType === 'input' && type === 'output') {
    // 反转连接
    fromId = id;
    toId = start.id;
}
```

## 🔄 数据流转

```
创意工作室 (输出)
    ↓
角色参考 (输入 → 输出)
    ↓
分镜生成 (输入)
```

现在连接线的方向和位置都正确了！
