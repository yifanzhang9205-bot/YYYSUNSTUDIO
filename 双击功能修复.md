# 双击功能修复（最终版本）

## 问题描述
双击画布无法呼出节点创建菜单。

## 根本原因

### 原因 1：mouseDown 事件阻止
在 `handleCanvasMouseDown` 函数中有一行代码阻止了所有多次点击事件：

```typescript
if (e.detail > 1) { e.preventDefault(); return; }
```

这个逻辑的原意是防止双击时触发选择框，但它同时也阻止了 `onDoubleClick` 事件的触发。

### 原因 2：事件冒泡未阻止
节点和分组没有阻止双击事件冒泡，导致在节点/分组上双击也会触发画布的双击菜单。

## 修复方案

### 1. 修改 handleCanvasMouseDown
改为只在单击时（`e.detail === 1`）才创建选择框：

```typescript
const handleCanvasMouseDown = (e: React.MouseEvent) => {
    if (contextMenu) setContextMenu(null); setSelectedGroupId(null);
    if (e.button === 0 && !e.shiftKey) { 
        // 不阻止双击事件，让 onDoubleClick 处理
        if (e.detail === 1) {
            setSelectedNodeIds([]); 
            setSelectionRect({ startX: e.clientX, startY: e.clientY, currentX: e.clientX, currentY: e.clientY }); 
        }
    }
    if (e.button === 1 || (e.button === 0 && e.shiftKey)) { 
        setIsDraggingCanvas(true); 
        setLastMousePos({ x: e.clientX, y: e.clientY }); 
    }
};
```

### 2. 简化 onDoubleClick 事件处理
移除复杂的目标检测，直接触发菜单：

```typescript
onDoubleClick={(e) => { 
    // 在画布空白处双击时弹出菜单
    e.preventDefault(); 
    e.stopPropagation();
    setContextMenu({ visible: true, x: e.clientX, y: e.clientY, id: '' }); 
    setContextMenuTarget({ type: 'create' }); 
}}
```

### 3. 节点阻止双击事件冒泡
在 Node.tsx 的节点容器上添加双击事件阻止：

```typescript
<div 
    className={`absolute rounded-[24px] group ...`}
    onMouseDown={(e) => onNodeMouseDown(e, node.id)} 
    onDoubleClick={(e) => e.stopPropagation()}  // 新增
    onMouseEnter={() => setIsHovered(true)} 
    onMouseLeave={() => setIsHovered(false)} 
    onContextMenu={(e) => onNodeContextMenu(e, node.id)}
>
```

### 4. 分组阻止双击事件冒泡
在 App.tsx 的分组容器上添加双击事件阻止：

```typescript
<div 
    key={g.id} 
    className={`absolute rounded-[32px] border ...`}
    onMouseDown={(e) => { ... }} 
    onDoubleClick={(e) => e.stopPropagation()}  // 新增
    onContextMenu={e => { ... }}
>
```

## 修复效果

1. **单击画布**：创建选择框（框选功能正常）
2. **双击画布空白处**：弹出节点创建菜单 ✅
3. **双击节点**：不会触发画布菜单（事件被阻止）✅
4. **双击分组**：不会触发画布菜单（事件被阻止）✅

## 技术细节

### e.detail 的含义
- `e.detail === 1`：单击
- `e.detail === 2`：双击
- `e.detail === 3`：三击
- 以此类推...

### 事件处理顺序
1. 第一次点击：`onMouseDown` (detail=1) → 创建选择框
2. 第二次点击：`onMouseDown` (detail=2) → 不创建选择框
3. 双击完成：`onDoubleClick` → 弹出菜单

### 事件冒泡控制
- **画布**：接收所有双击事件，弹出菜单
- **节点/分组**：阻止双击事件冒泡（`e.stopPropagation()`），防止触发画布菜单
- **节点内部元素**：部分元素也有 `stopPropagation()`，确保交互正确

## 测试建议

1. **单击测试**：单击画布空白处，应该开始框选（不弹出菜单）
2. **双击画布测试**：双击画布空白处，应该弹出节点创建菜单
3. **双击节点测试**：双击节点，不应该弹出画布菜单
4. **双击分组测试**：双击分组，不应该弹出画布菜单
5. **快速点击测试**：快速连续点击多次，确保不会出现异常行为
6. **缩放后测试**：缩放画布后双击，菜单应该出现在正确位置

