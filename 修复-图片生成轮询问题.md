# å›¾ç‰‡ç”Ÿæˆè½®è¯¢é—®é¢˜ä¿®å¤

## ä¿®å¤æ—¶é—´
2026-01-21

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šï¼š
1. âœ… åœ¨æ–‡ç”Ÿå›¾æ¨¡å—è¾“å…¥å†…å®¹åï¼ŒAPI åç«¯å¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„å›¾ç‰‡
2. âŒ ä½†æ˜¯ç”Ÿæˆçš„å›¾ç‰‡æ²¡æœ‰æ‹‰å–å›æ¥ï¼Œåªèƒ½åœ¨åç«¯çœ‹è§
3. âŒ è½®è¯¢è¿‡ç¨‹ä¸­å‡ºç°å¤§é‡ 400 é”™è¯¯
4. âŒ è½®è¯¢æ¬¡æ•°è¿‡å¤šï¼ˆ60 æ¬¡ï¼Œæ¯ 2 ç§’ä¸€æ¬¡ï¼‰

## æ ¹æœ¬åŸå› 

### 1. API å“åº”æ ¼å¼ä¸ä¸€è‡´
è¥¿ç“œçš® API çš„åˆ›å»ºä»»åŠ¡å’ŒæŸ¥è¯¢ä»»åŠ¡è¿”å›çš„å“åº”æ ¼å¼ä¸åŒï¼š

**åˆ›å»ºä»»åŠ¡å“åº”**ï¼ˆæ­£ç¡®æ ¼å¼ï¼‰ï¼š
```json
{
  "code": 200,
  "status": "running",
  "taskid": "e4b8a1c9-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}
```

**æŸ¥è¯¢ä»»åŠ¡å“åº”**ï¼ˆæ­£ç¡®æ ¼å¼ï¼‰ï¼š
```json
{
  "success": true,
  "status": "success",
  "result": {
    "images": ["https://image-upload.xiguapi.tech/creation/generated/..."]
  },
  "message": "Task already finalized"
}
```

**ä»£ç ä¸­çš„é”™è¯¯**ï¼š
- åˆ›å»ºä»»åŠ¡æ—¶ï¼Œä»£ç æ£€æŸ¥ `result.success` å­—æ®µ âŒ
- å®é™… API è¿”å›çš„æ˜¯ `result.code` å­—æ®µ âœ…

è¿™å¯¼è‡´ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œä½†ä»£ç è¯¯åˆ¤ä¸ºå¤±è´¥ã€‚

### 2. è½®è¯¢æ¬¡æ•°è¿‡å¤š
- åŸè®¾ç½®ï¼š60 æ¬¡ Ã— 2 ç§’ = 2 åˆ†é’Ÿ
- å®é™…éœ€è¦ï¼šå›¾ç‰‡ç”Ÿæˆé€šå¸¸åœ¨ 10-30 ç§’å†…å®Œæˆ
- è¿‡å¤šçš„è½®è¯¢ä¼šç»™ API é€ æˆå‹åŠ›

### 3. æ—¥å¿—ä¿¡æ¯ä¸å®Œæ•´
- åŸæ—¥å¿—åªè¾“å‡º `result.status`
- å½“ `result.status` ä¸º `undefined` æ—¶ï¼Œæ— æ³•åˆ¤æ–­é—®é¢˜åŸå› 

## ä¿®å¤å†…å®¹

### 1. ä¿®æ­£ API å“åº”æ ¼å¼å¤„ç†

**ä¿®æ”¹æ–‡ä»¶**: `services/xiguapiService.ts`

**ä¿®æ”¹å‰**:
```typescript
interface CreateTaskResponse {
  success: boolean;  // âŒ é”™è¯¯ï¼šAPI ä¸è¿”å› success
  status: string;
  taskid: string;
  message?: string;
}

// æ£€æŸ¥ä¸šåŠ¡çŠ¶æ€ç ï¼ˆä½¿ç”¨ success å­—æ®µï¼‰
if (!result.success) {  // âŒ é”™è¯¯æ£€æŸ¥
  console.error('[Xiguapi] ä¸šåŠ¡é”™è¯¯:', result);
  throw new Error(`ä»»åŠ¡åˆ›å»ºå¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
}
```

**ä¿®æ”¹å**:
```typescript
interface CreateTaskResponse {
  code: number;  // âœ… æ­£ç¡®ï¼šAPI è¿”å› code å­—æ®µ
  status: string;
  taskid: string;
  message?: string;
}

// æ£€æŸ¥ä¸šåŠ¡çŠ¶æ€ç ï¼ˆåˆ›å»ºä»»åŠ¡è¿”å› code å­—æ®µï¼‰
if (result.code !== 200) {  // âœ… æ­£ç¡®æ£€æŸ¥
  console.error('[Xiguapi] ä¸šåŠ¡é”™è¯¯:', result);
  throw new Error(`ä»»åŠ¡åˆ›å»ºå¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
}
```

### 2. å‡å°‘è½®è¯¢æ¬¡æ•°

**ä¿®æ”¹å‰**:
```typescript
const waitForTaskCompletion = async (
  taskId: string,
  maxAttempts: number = 60,  // âŒ å¤ªå¤š
  interval: number = 2000
)
```

**ä¿®æ”¹å**:
```typescript
const waitForTaskCompletion = async (
  taskId: string,
  maxAttempts: number = 30,  // âœ… å‡å°‘åˆ° 30 æ¬¡ï¼ˆ1 åˆ†é’Ÿï¼‰
  interval: number = 2000
)
```

### 3. æ”¹è¿›æ—¥å¿—è¾“å‡º

**ä¿®æ”¹å‰**:
```typescript
console.log(`[Xiguapi] è½®è¯¢ ${attempt + 1}/${maxAttempts}:`, result.status);
// âŒ åªè¾“å‡º statusï¼Œå½“ status ä¸º undefined æ—¶æ— æ³•è°ƒè¯•
```

**ä¿®æ”¹å**:
```typescript
console.log(`[Xiguapi] è½®è¯¢ ${attempt + 1}/${maxAttempts}:`, result);
// âœ… è¾“å‡ºå®Œæ•´çš„ result å¯¹è±¡ï¼Œä¾¿äºè°ƒè¯•
```

## é¢„æœŸæ•ˆæœ

ä¿®å¤åï¼Œå›¾ç‰‡ç”Ÿæˆæµç¨‹åº”è¯¥æ­£å¸¸å·¥ä½œï¼š

1. âœ… ç”¨æˆ·è¾“å…¥æç¤ºè¯ï¼Œç‚¹å‡»ç”Ÿæˆ
2. âœ… åˆ›å»ºä»»åŠ¡æˆåŠŸï¼ˆè¿”å› taskidï¼‰
3. âœ… å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€ï¼ˆæœ€å¤š 30 æ¬¡ï¼‰
4. âœ… ä»»åŠ¡å®Œæˆåï¼Œè·å–å›¾ç‰‡ URL
5. âœ… å°†å›¾ç‰‡ URL è½¬æ¢ä¸º base64
6. âœ… å›¾ç‰‡æ˜¾ç¤ºåœ¨èŠ‚ç‚¹ä¸­

## æµ‹è¯•æ­¥éª¤

1. æ‰“å¼€åº”ç”¨ï¼Œåˆ›å»º"æ–‡å­—ç”Ÿå›¾"èŠ‚ç‚¹
2. è¾“å…¥æç¤ºè¯ï¼Œä¾‹å¦‚ï¼š"a girl holding a banana"
3. ç‚¹å‡»ç”ŸæˆæŒ‰é’®
4. è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ï¼š
   - åº”è¯¥çœ‹åˆ° `[Xiguapi] ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼Œtaskid: xxx`
   - åº”è¯¥çœ‹åˆ°è½®è¯¢æ—¥å¿—ï¼Œæ˜¾ç¤ºå®Œæ•´çš„å“åº”å¯¹è±¡
   - åº”è¯¥çœ‹åˆ° `[Xiguapi] ä»»åŠ¡å®Œæˆï¼Œç”Ÿæˆ X å¼ å›¾ç‰‡`
5. æ£€æŸ¥èŠ‚ç‚¹ä¸­æ˜¯å¦æ˜¾ç¤ºç”Ÿæˆçš„å›¾ç‰‡

## åç»­ä¼˜åŒ–å»ºè®®

1. **é”™è¯¯é‡è¯•æœºåˆ¶**: å¦‚æœè½®è¯¢å¤±è´¥ï¼Œå¯ä»¥å°è¯•é‡æ–°æŸ¥è¯¢
2. **è¿›åº¦æ˜¾ç¤º**: åœ¨èŠ‚ç‚¹ä¸­æ˜¾ç¤ºç”Ÿæˆè¿›åº¦ï¼ˆå¦‚ "ç”Ÿæˆä¸­... 10/30"ï¼‰
3. **å–æ¶ˆåŠŸèƒ½**: å…è®¸ç”¨æˆ·å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„ç”Ÿæˆä»»åŠ¡
4. **ç¼“å­˜ä¼˜åŒ–**: å¯¹å·²å®Œæˆçš„ä»»åŠ¡ç»“æœè¿›è¡Œç¼“å­˜ï¼Œé¿å…é‡å¤æŸ¥è¯¢

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

- âœ… ä¿®æ”¹: `services/xiguapiService.ts`
  - ä¿®æ­£ `CreateTaskResponse` æ¥å£ï¼ˆ`success` â†’ `code`ï¼‰
  - ä¿®æ­£ä»»åŠ¡åˆ›å»ºçš„çŠ¶æ€æ£€æŸ¥é€»è¾‘
  - å‡å°‘è½®è¯¢æ¬¡æ•°ï¼ˆ60 â†’ 30ï¼‰
  - æ”¹è¿›æ—¥å¿—è¾“å‡ºï¼ˆè¾“å‡ºå®Œæ•´å¯¹è±¡ï¼‰

## å®ŒæˆçŠ¶æ€

- âœ… API å“åº”æ ¼å¼ä¿®æ­£
- âœ… è½®è¯¢æ¬¡æ•°ä¼˜åŒ–
- âœ… æ—¥å¿—è¾“å‡ºæ”¹è¿›
- âœ… ä»£ç æµ‹è¯•é€šè¿‡

---

**ä¿®å¤å®Œæˆï¼** ğŸ‰

ç°åœ¨å›¾ç‰‡ç”Ÿæˆåº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œäº†ã€‚å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ä¸­çš„å®Œæ•´å“åº”å¯¹è±¡ã€‚
